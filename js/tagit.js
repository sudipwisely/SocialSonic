!function(a){a.fn.autoGrowInput=function(b){return b=a.extend({maxWidth:1e3,minWidth:0,comfortZone:70},b),this.filter("input:text").each(function(){var c=b.minWidth||a(this).width(),d="",e=a(this),f=a("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:e.css("fontSize"),fontFamily:e.css("fontFamily"),fontWeight:e.css("fontWeight"),letterSpacing:e.css("letterSpacing"),whiteSpace:"nowrap"}),g=function(){if(d!==(d=e.val())){var a=d.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");f.html(a);var g=f.width(),h=g+b.comfortZone>=c?g+b.comfortZone:c,i=e.width(),j=h<i&&h>=c||h>c&&h<b.maxWidth;if(j){var k=e.attr("style");e.css("cssText","width: "+h+"px !important;"+k)}}};f.insertAfter(e),a(this).bind("keyup keydown blur update",g)}),this}}(jQuery),function(a){a.widget("custom.catcomplete",a.ui.autocomplete,{_renderMenu:function(b,c){var d=this,e="";a.each(c,function(a,c){c.category&&c.category!=e&&(b.append("<li class='ui-autocomplete-category'>"+c.category+"</li>"),e=c.category),d._renderItemData(b,c)})}}),a.widget("ui.tagit",{options:{tagSource:[],triggerKeys:["enter","space","comma","tab","semicolon"],seperatorKeys:["comma","semicolon"],initialTags:[],defaultType:"none",minLength:1,autocompleteMinLength:1,select:!1,allowNewTags:!0,caseSensitive:!1,sortable:!1,editable:!1,highlightOnExistColor:"#0F0",emptySearch:!0,tagsChanged:function(a,b,c){},maxTags:void 0,blurOnPaste:!0},_splitAt:/\ |,/g,_existingAtIndex:0,_keys:{backspace:[8],enter:[13],space:[32],comma:[44,188],tab:[9],semicolon:[59,186]},_sortable:{sorting:-1},_idEditing:!1,_create:function(){var b=this;this.tagsArray=[],this.timer=null,this.lastKey=0,this.element.addClass("tagit"),this.element.children("li").each(function(){var c=a(this),d=c.attr("tagValue")||c.data("value");b.options.initialTags.push({label:c.text(),value:d?d:c.text()})}),pushRegex=function(d,e,f){a.inArray(e,b.options.seperatorKeys)!=-1&&c.push(f)},b._splitAt=null;var c=[];pushRegex(c,"space",/\ /),pushRegex(c,"semicolon",/;/),pushRegex(c,"comma",/,/);var d=a.map(c,function(a){return a.source}).join("|");b._splitAt=new RegExp(d,"g"),this.element.html('<li class="tagit-new"><input class="tagit-input" type="text" /></li>'),this.input=this.element.find(".tagit-input"),this.input.autoGrowInput(),a(this.element).click(function(c){if(a(c.target).hasClass("tagit-close")){var d=a(c.target).parent(),e=b.tagsArray[d.index()];e.element.remove(),b._popTag(e)}else b._isEditing||b.input.focus(),b.options.emptySearch&&a(c.target).hasClass("tagit-input")&&""==b.input.val()&&void 0!=b.input.catcomplete&&b.input.catcomplete("search"),b.options.editable&&a(c.target).hasClass("tagit-label")&&b._edit(c.target)});var e=this.options.select,f=this.options.minLength;if(this.options.appendTo=this.element,this.options.source=this.options.tagSource,this.options.select=function(a,c){return b.input.data("autoCompleteTag",!0),clearTimeout(b.timer),void 0!==b.options.maxTags&&b.tagsArray.length==b.options.maxTags?b.input.val(""):void 0===c.item.label?b._addTag({label:c.item.value}):b._addTag({label:c.item.label,value:c.item.value,type:c.item.category}),!1},this.options.focus=function(a,c){if(void 0!==c.item.label&&/^key/.test(a.originalEvent.type))return b.input.val(c.item.label),b.input.data("value",c.item.value),!1},this.options.autoFocus=!this.options.allowNewTags,this.options.minLength=this.options.autocompleteMinLength,this.input.catcomplete(this.options),this.options.minLength=f,this.options.select=e,b.isKeyEventProcessed=!1,this.input.keyup(function(a){b.isKeyEventProcessed=!1}),this.input.keydown(function(a){b._processKeyEvent(a)}),this.input.keypress(function(a){b._processKeyEvent(a)}),this.input.bind("paste",function(c){if(b.options.blurOnPaste){var d=a(this);b.timer=setTimeout(function(){d.blur()},0)}}),this.input.blur(function(c){return b.currentLabel=a(this).val(),b.currentValue=a(this).data("value"),b.options.allowNewTags&&(b.timer=setTimeout(function(){b._addTag({label:b.currentLabel,value:b.currentValue,type:b.options.defaultType}),b.currentValue="",b.currentLabel=""},400)),a(this).val("").removeData("value"),!1}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),this.options.select&&(this.select=a('<select class="tagit-hiddenSelect" name="'+(this.element.attr("name")||this.element.data("name"))+'" multiple="multiple"></select>'),this.element.after(this.select)),this._initialTags(),b.options.sortable!==!1){var g={items:".tagit-choice",containment:"parent",opacity:.6,tolerance:"pointer",start:function(c,d){b._sortable.tag=a(d.item),b._sortable.origIndex=b._sortable.tag.index()},update:function(a,c){if(b._sortable.newIndex=b._sortable.tag.index(),b._moveTag(b._sortable.origIndex,b._sortable.newIndex),b.options.tagsChanged){var d=b.tagsArray[b._sortable.newIndex];b.options.tagsChanged(d.value,"moved",d.element)}}};"handle"==b.options.sortable&&(g.handle="a.ui-icon",g.cursor="move"),b.element.sortable(g)}},_processKeyEvent:function(a){if(!this.isKeyEventProcessed){var b=a.which||a.keyCode||a.charCode,c=this.element.children(".tagit-choice:last");if(this.isKeyEventProcessed=!0,b==this._keys.backspace)return this._backspace(c);!this._isInitKey(b)||this._isTabKey(b)&&""==this.value&&!this.input.data("autoCompleteTag")||(a.preventDefault(),this.input.data("autoCompleteTag",!1),!this.options.allowNewTags||void 0!==this.options.maxTags&&this.tagsArray.length==this.options.maxTags?this.input.val(""):this.options.allowNewTags&&this.input.val().length>=this.options.minLength&&this._addTag({label:this.input.val(),type:this.options.defaultType})),void 0!==this.options.maxLength&&this.input.val().length>this.options.maxLength&&(a.preventDefault(),this.input.val(this.input.val().substring(0,this.options.maxLength))),c.hasClass("selected")&&c.removeClass("selected"),this.lastKey=b}},_postEdit:function(b,c,d){var e=a.proxy(function(){c.remove(),a(b).removeClass("hidden"),a(b).parent().removeClass("edited"),this._isEditing=!1},this);return function(){var f=a(b).parent().index(),g=this.tagsArray[f],h=c.val();if(this._splitAt&&h.search(this._splitAt)>0&&(h=h.split(this._splitAt)[0]),h==d)e();else if(this._addTag({label:h})){g.element.remove(),this._popTag(g);var i=this.tagsArray.length-1;if(i!=f){var j=this.tagsArray[i];if(j.element.insertBefore(this.tagsArray[f].element),this._moveTag(this.tagsArray.length-1,f),this.options.tagsChanged){var k=this.tagsArray[f];this.options.tagsChanged(k.value,"moved",k.element)}}e()}}},_edit:function(b){this._isEditing=!0;var c=a(b).text(),d=a("<input>");d.val(c),a(b).parent().addClass("edited"),d.addClass("tagit-edit"),d.css("width",a(b).outerWidth()),a(b).addClass("hidden"),d.blur(a.proxy(this._postEdit(b,d,c),this)),d.keypress(a.proxy(function(a){var b=a.which||a.keyCode||a.charCode;this._isInitKey(b)&&d.blur()},this)),a(b).before(d),d[0].select()},_popSelect:function(b){a("option:eq("+b.index+")",this.select).remove(),this.select.change()},_addSelect:function(a){this.select.append('<option selected="selected" value="'+a.value+'">'+a.label+"</option>"),this.select.change()},_popTag:function(a){void 0===a?a=this.tagsArray.pop():this.tagsArray.splice(a.index,1);for(var b in this.tagsArray)this.tagsArray[b].index=b;this.options.select&&this._popSelect(a),this.options.tagsChanged&&this.options.tagsChanged(a?a.value||a.label:null,"popped",a)},_addTag:function(b){if(void 0===b.label&&(b.label=b.value),this.input.catcomplete("close").val(""),!(this._splitAt&&b.label.search(this._splitAt)>0)){if(b.label=b.label.replace(/,+$/,"").trim(),""==b.label)return!1;b.label=b.label.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var e=this._exists(b.label,b.value);if(e!==!1)return this._highlightExisting(e),!1;var f=this.tag(b.label,b.value,b.type);return f.element=a('<li class="tagit-choice'+(void 0!==b.type?" tagit-type-"+b.type+'"':'"')+(void 0!==b.value?' tagValue="'+b.value+'"':"")+">"+("handle"==this.options.sortable?'<a class="ui-icon ui-icon-grip-dotted-vertical" style="float:left"></a>':"")+'<div class="tagit-label">'+b.label+'</div><a class="tagit-close">x</a></li>'),f.element.insertBefore(this.input.parent()),this.tagsArray.push(f),this.input.val(""),this.options.select&&this._addSelect(f),this.options.tagsChanged&&this.options.tagsChanged(f.label,"added",f.element),!0}for(var c=b.label.split(this._splitAt),d=0;d<c.length;d++)this._addTag({label:c[d],value:b.value})},_exists:function(a,b){if(0==this.tagsArray.length)return!1;a=this._lowerIfCaseInsensitive(a),b=this._lowerIfCaseInsensitive(b);for(var c in this.tagsArray)if(this._lowerIfCaseInsensitive(this.tagsArray[c].label)==a){if(void 0===b)return c;if(this._lowerIfCaseInsensitive(this.tagsArray[c].value)==b)return c}return!1},_highlightExisting:function(a){if(void 0!==this.options.highlightOnExistColor){var b=this.tagsArray[a];b.element.stop();var c=b.element.css("color");b.element.animate({color:this.options.highlightOnExistColor},100).animate({color:c},800,null,function(){b.element.attr("style","")})}},_isInitKey:function(b){var c="";for(var d in this._keys)a.inArray(b,this._keys[d])!=-1&&(c=d);return a.inArray(c,this.options.triggerKeys)!=-1},_isTabKey:function(b){var c=this._keys.tab;return a.inArray(b,c)>-1},_removeTag:function(){this._popTag(),this.element.children(".tagit-choice:last").remove()},_backspace:function(a){return""==this.input.val()&&(this.lastKey==this._keys.backspace?(this._popTag(),a.remove(),this.lastKey=null):(a.addClass("selected"),this.lastKey=this._keys.backspace)),!0},_initialTags:function(){var c,b=this;this.options.tagsChanged&&(c=this.options.tagsChanged),this.options.tagsChanged=null,0!=this.options.initialTags.length&&a(this.options.initialTags).each(function(a,c){"object"==typeof c?b._addTag({label:c.label,value:c.value,type:c.type}):b._addTag({label:c})}),this.options.tagsChanged=c,this.options.tagsChanged(null,"tagsInited",null)},_lowerIfCaseInsensitive:function(a){return void 0===a||"string"!=typeof a?a:this.options.caseSensitive?a:a.toLowerCase()},_moveTag:function(b,c){this.tagsArray.splice(c,0,this.tagsArray.splice(b,1)[0]);for(var d in this.tagsArray)this.tagsArray[d].index=d;this.options.select&&a("option:eq("+b+")",this.select).insertBefore(a("option:eq("+c+")",this.select))},tags:function(){return this.tagsArray},destroy:function(){a.Widget.prototype.destroy.apply(this,arguments),clearTimeout(this.timer),this.tagsArray=[]},reset:function(){this.element.find(".tagit-choice").remove(),this.tagsArray=[],this.options.select&&(this.select.children().remove(),this.select.change()),this._initialTags(),this.options.tagsChanged&&this.options.tagsChanged(null,"reset",null)},fill:function(a){void 0!==a&&(this.options.initialTags=a),this.reset()},add:function(a,b){return"object"==typeof a?this._addTag({label:a.label,value:a.value}):this._addTag({label:a,value:b})},autocomplete:function(){return this.input.data("autocomplete")},tag:function(a,b,c,d){var e=this;return{label:a,value:void 0===b?a:b,type:c,element:d,index:e.tagsArray.length}},remove:function(a,b){if(0==this.tagsArray.length)return!1;a=this._lowerIfCaseInsensitive(a),b=this._lowerIfCaseInsensitive(b);for(var c=0;c<this.tagsArray.length&&(this._lowerIfCaseInsensitive(this.tagsArray[c].value)!=b&&this._lowerIfCaseInsensitive(this.tagsArray[c].label)!=a);c++);if(c>=0&&c<this.tagsArray.length){var d=this.tagsArray[c];return d.element.remove(),this._popTag(d),!0}return!1}})}(jQuery);